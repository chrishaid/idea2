---
title: "KTC Data Explorer"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    theme: lumen
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}

library(dplyr)
library(lubridate)
library(ggplot2)
library(flexdashboard)
library(shiny)
library(timevis)
library(Cairo)
library(sunburstR)
library(stringr)
library(purrr)
library(tidyr)
library(janitor)
library(forcats)
library(formattable)



enableBookmarking(store = "url")
# Load assignments data
load("/data/ktc.Rda")

# Source functions
source("lib/ktc_helpers.R")

# some constants
classes <- c(2011:2020)

counselors <- unique(contacts_summary$name.y)

statuses <- unique(contacts_summary$status_c) %>% discard(is.na)

counselors_2021 <- c("Catrina Thomas", "China Hill", "Tiffany Harrell")

 todays_date <- today()
 days_elapsed_7 <- todays_date - days(7)
 days_elapsed_30 <- todays_date - days(30)
 days_elapsed_90 <- todays_date - days(90)

 start <- ymd("2017-01-01")
 daily <- 739 / (96 * 6)
 contact_goal_7 <- daily * 7 #15
 contact_goal_30 <- daily * 30 #as.integer(contact_goal_7 / 7 * 30)
 contact_goal <- 739 / 6

 day <- wday(today(), label=TRUE)
 week <- today() %m-% days(1:7)
 last_sunday <- which(wday(week, label=TRUE) %in% "Sun")
 set_date <- ifelse(day == "Sun", today(), week[last_sunday])

 noble_schools <-
  c("Rowe-Clark Math and Science Academy",
    "Chicago Bulls College Prep",
    "UIC College Prep",
    "Muchin College Prep",
    "DRW Trading College Prep",
    "Noble Street College Prep",
    "Rauner College Prep",
    "Golder College Prep",
    "ITW David Speer Academy",
    "Pritzker College Prep",
    "The Noble Academy",
    "Gary Comer College Prep",
    "Baker College Prep",
    "Butler College Preparatory High School",
    "Johnson College Prep",
    "Baker College Preparatory High School",
    "Hansberry College Preparatory High School",
    "Mansueto College Prep"
    )

# update class_all with Noble schools

class_all <- class_all %>%
  dplyr::mutate(noble = school_name %in% noble_schools,
                type_noble = if_else(noble, "Noble", type),
                noble_2 = if_else(noble, "Noble", "Other"))

```

Unique and Total Contacts{data-navmenu="Contacts"}
======================================================================
Inputs {.sidebar}
-----------------------------------------------------------------------
```{r}

selectInput("class",
            "Class of",
            choices = classes,
            multiple = TRUE,
            selected = classes)

selectInput("counselor",
            "Counselors",
            choices = counselors,
            multiple = TRUE,
            selected = c("Catrina Thomas",
                         "China Hill",
                         "Deja Manuel",
                         "Jamie Hawley",
                         "Margarita Herrera",
                         "Pete Gooden"))
checkboxGroupInput("status",
         "Status type",
         choices = c("Successful", "Outreach"),
         selected = "Successful")

radioButtons("facet_by",
             "Show by",
             choices = c("Counselor" = "name.y",
                            "Class" = "kipp_hs_class_c",
                            "Both" = "kipp_hs_class_c ~ name.y"
                            )
            )


bookmarkButton()

```



Row
-----------------------------------------------------------------------
```{r}
contacts_filtered <- reactive({
  filtered <- contacts_details %>%
    filter(kipp_hs_class_c %in% input$class,
           name.y %in% input$counselor,
           status_c %in% "Successful")

  out<-list()


  out$last_7 <- nrow(filtered %>%
                        filter(date_c >= as_date(set_date)) %>%
                         select(contact_c) %>%
                         unique()
                )

  out$last_30 <- nrow(filtered %>%
                        filter(date_c >= days_elapsed_30) %>%
                         select(contact_c) %>%
                         unique()
                )

  out$begin <- nrow(filtered %>%
                        filter(date_c >= start) %>%
                         select(contact_c) %>%
                         unique()
                )


  out

  })

# contacts_total <- renderText(contacts_filtered()$total)
# contacts_7 <- renderText(contacts_filtered()$last_7)
# contacts_30 <- renderText(contacts_filtered()$last_30)

```

### Contacts last 90 days

```{r}
renderValueBox({
  valueBox(value = contacts_filtered()$begin,
           caption = sprintf("Contacts since Jan 1st (goal: %s)",
                             floor(contact_goal*length(input$counselor))),
    icon = "fa-calendar-check-o",
    color = ifelse(contacts_filtered()$begin < contact_goal*length(input$counselor), "warning", "primary"))
  })
```

### Contacts last 30 days

```{r}
renderValueBox({
  valueBox(value = contacts_filtered()$last_30,
           caption = sprintf("Contacts last 30 days (goal: %s)",
                             floor(contact_goal_30*length(input$counselor))),
    icon = "fa-calendar-check-o",
    color = ifelse(contacts_filtered()$last_30 < floor(contact_goal_30*length(input$counselor)), "warning", "primary"))
  })
```


### Contacts last 7 days

```{r}
renderValueBox({
  valueBox(value = contacts_filtered()$last_7,
           caption = sprintf("Contacts since Sunday (goal: %s)",
                             floor(contact_goal_7*length(input$counselor))),
    icon = "fa-calendar-check-o",
    color = ifelse(contacts_filtered()$last_7 < floor(contact_goal_7*length(input$counselor)), "warning", "primary"))
  })
```



Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

###Unique {.no-padding}


```{r}
plotOutput("unicontacts_flow",
            brush = brushOpts(id = "plot_brush", direction = "x")
          )


output$unicontacts_flow <-renderPlot({

if(!grepl("~", input$facet_by)) { # not class and counselor

  if(input$facet_by == "name.y") { #if counselor
    filter_cond <- ~ name.y %in% input$counselor

  } else { # if class
    filter_cond <- ~ kipp_hs_class_c %in% input$class

  }

  # Class or counselor plot
  p <- contacts_details %>%
  filter(kipp_hs_class_c %in% classes,
         status_c %in% statuses) %>%
  group_by_("date_c", "status_c", "contact_c", input$facet_by) %>%
  summarise() %>%
  filter_(filter_cond,
          ~date_c >= start) %>%
  ungroup()

  first_success <- p %>%
    filter(!duplicated(contact_c),
           status_c %in% "Successful")

  first_outreach <- p %>%
    filter(!duplicated(contact_c),
           status_c %in% "Outreach")

  outreach_success <- p %>%
    distinct(contact_c, status_c, .keep_all=TRUE) %>%
    filter(status_c %in% "Successful") %>%
    semi_join(first_outreach, by="contact_c")

  u_table <- bind_rows(first_success, first_outreach, outreach_success) %>%
    group_by_("date_c", input$facet_by, "status_c") %>%
    summarise(N=n()) %>%
    ggplot(aes(x = date_c, y = N)) +
    geom_bar(color = "white",
           stat ="identity",
           aes(alpha = status_c),
           fill = '#440154FF') +
    scale_alpha_discrete(range = c(1/5, 1),
                       guide = guide_legend(title= NULL)) +
    facet_wrap(input$facet_by) +
    scale_x_datetime(date_labels = "%b %d",
                   date_breaks = "1 week") +
    theme_bw() +
    theme(legend.position = "bottom",
        axis.text.x = element_text(angle=45, hjust = 1)) +
    labs(y = "Number of contacts",
       x = "Date", fill=NULL)
  } else { # both class and counselor

     # Class and counselor plot

    p <- contacts_details %>%
      filter(status_c %in% statuses) %>%
      group_by_("date_c", "status_c", "contact_c", "name.y", "kipp_hs_class_c")  %>%
      summarise() %>%
      filter(name.y %in% input$counselor,
             kipp_hs_class_c %in% input$class,
             date_c >= start) %>%
      ungroup()

    first_success <- p %>%
      filter(!duplicated(contact_c),
             status_c %in% "Successful")

    first_outreach <- p %>%
      filter(!duplicated(contact_c),
             status_c %in% "Outreach")

    outreach_success <- p %>%
      distinct(contact_c, status_c, .keep_all=TRUE) %>%
      filter(status_c %in% "Successful") %>%
     semi_join(first_outreach, by="contact_c")

    u_table <- bind_rows(first_success, first_outreach, outreach_success) %>%
      group_by(date_c, name.y, kipp_hs_class_c, status_c) %>%
      summarise(N=n()) %>%
      ggplot(aes(x = date_c, y = N)) +
      geom_bar(color = "white",
               stat ="identity",
               aes(alpha = status_c),
               fill = '#440154FF') +
      scale_alpha_discrete(range = c(1/5, 1),
                       guide = guide_legend(title= NULL)) +
      facet_grid(name.y ~ kipp_hs_class_c) +
      scale_x_datetime(date_labels = "%b %d",
                   date_breaks = "1 week") +
      theme_bw() +
      theme(legend.position = "bottom",
        axis.text.x = element_text(angle=45, hjust = 1)) +
      labs(y = "Number of contacts",
       x = "Date", fill=NULL)
  }


  u_table

 })

```

### Total {.no-padding}

```{r}

plotOutput("contacts_flow",
            brush = brushOpts(id = "plot_brush", direction = "x")
          )


output$contacts_flow <-renderPlot({

if(!grepl("~", input$facet_by)) { # not class and counselor

  if(input$facet_by == "name.y") { #if counselor
    filter_cond <- ~ name.y %in% input$counselor
  } else { # if class
    filter_cond <- ~ kipp_hs_class_c %in% input$class
  }

  # Class or counselor plot
  p <- contacts_details %>%
    filter(status_c %in% input$status,
           kipp_hs_class_c %in% classes) %>% ##added since we were capturing 2021 data ) %>%
    group_by_("date_c", input$facet_by) %>%
    summarize(N = n()) %>%
    filter_(filter_cond,
          ~ date_c >= days_elapsed_90
          ) %>%
    ggplot(aes(x=date_c, y=N)) +
      geom_bar(aes(
                   fill = N >= contact_goal_7/7),
               color = "white",
               stat="identity") +
      facet_wrap(input$facet_by) +
      viridis::scale_fill_viridis("Daily contacts > 2",
                                  option = "D",
                                  discrete= TRUE,
                                  direction = -1) +
      scale_x_datetime(date_labels = "%b %d",
                       date_breaks = "1 week") +
      theme_bw() +
      theme(legend.position = "bottom",
            axis.text.x = element_text(angle=45, hjust = 1)) +
      labs(y = "Number of contacts",
           x = "Date")
  } else { # both class and counselor

    # Class and counselor plot
    p <- contacts_details %>%
      filter(status_c %in% input$status) %>%
      group_by(date_c, name.y, kipp_hs_class_c) %>%
      summarize(N = n()) %>%
      filter(name.y %in% input$counselor,
              kipp_hs_class_c %in% input$class,
              date_c >= days_elapsed_90
            ) %>%
      ggplot(aes(x=date_c, y=N)) +
        geom_bar(aes(
                     fill = N >= contact_goal_7/7),
                 color = NA,
                 stat="identity") +
        facet_grid(name.y ~ kipp_hs_class_c) +
        viridis::scale_fill_viridis("Daily contacts > 2",
                                    option = "D",
                                    discrete= TRUE,
                                    direction = -1) +
        scale_x_datetime(date_labels = "%b %d",
                         date_breaks = "1 week") +
        theme_bw() +
        theme(legend.position = "bottom",
              axis.text.x = element_text(angle=45, hjust = 1)) +
        labs(y = "Number of contacts",
             x = "Date")

  }


  p

 })

```

Projection {data-navmenu="Contacts"}
========================================================

Inputs {.sidebar}
--------------------------------------------------------
```{r}
radioButtons("line_proj", "Show",
             choices = c("Goal" = "goal",
                         "Projection (2017 Data)" = "2017",
                         "Projection (Historical Data)" = "prophet",
                         "All" = "all"),
             selected = "all",
             inline = FALSE)
dateInput("proj_date", "End Date",
          value = "2017-04-07",
          max = "2017-04-07",
          min = "2017-01-01",
          format = "yyyy-mm-dd",
          startview = "month")

```

Data that fall within January 1, 2017 and **End Date** will be included in the model Projection (End Date). Choose a date to see how the projection changes over time.


The Projection (Historical Data) model includes data from February 4, 2010 through February 28, 2017.

Row
----------------------------------------------------------
### Projection

```{r}
plotOutput("proj_plot",
            brush = brushOpts(id = "proj_brush", direction = "x")
          )
```

```{r}

output$proj_plot <-renderPlot({
  success_csum <- df_final_csum %>%
    filter(ds >= ymd("2017-01-01") &
    ds <= ymd("2017-04-07"))

  success_csum_date <- df_final_csum %>%
    filter(ds >= ymd("2017-01-01") &
    ds <= input$proj_date)

  q_mod_date <- lm(y ~ I(as.numeric(ds)) + I(as.numeric(ds)^2),
              data = success_csum_date)

  goal_tbl$qmod_date <- predict(q_mod_date, goal_tbl[,"ds"])

  plotdf <- prophet_dat %>%
    filter(ds >= ymd("2017-01-01"),
           ds < ymd("2017-04-08")) %>%
    mutate(ds = as.POSIXct(ds))

  p_graph <-
     ggplot(data = success_csum_date, aes(x = ds, y = y)) +
     geom_step(aes(color = "Total to date"),
               stat = "identity",
               position = "identity") +
    geom_line(data = goal_tbl, aes(x=ds, y= goal_n,
                                   color = "Goal"),
                                   stat = "identity") +
    geom_vline(xintercept = as.numeric(as.POSIXct("2017-04-07")),
               color = "#C83E73FF") +
    scale_x_datetime(date_labels = "%b %d",
                     date_breaks = "1 week",
                     limits = as.POSIXct(c("2017-01-01", "2017-04-07"))) +
    scale_color_manual(name = NULL,
                       values = c("Total to date" = "black",
                                  "Goal" = "#451077FF",
                                  "Projection (historical)" = "#FEC98DFF",
                                  "Projection (2017)" = "#238A8DFF",
                                  "Projection (week 6)" = "steelblue1",
                                  "Projection (End Date)" = "red" ),
                       guide = "legend") +
    theme_bw() +
    theme(legend.position = "top") +
    labs(y = "Number of successful contacts",
         x = "Date")

  if(input$line_proj %in% "2017"){

  p_graph <- p_graph +
    geom_line(data = goal_tbl, aes(x=ds, y= qmod,
                                   color = "Projection (2017)"),
              stat = "identity")
  }

  if(input$line_proj %in% "prophet"){
  p_graph <- p_graph +
    geom_line(data = plotdf, aes(x = ds, y = yhat,
                                color = "Projection (historical)")) +
    geom_ribbon(data = plotdf, aes(x = ds, ymin = yhat_lower,
                                   ymax = yhat_upper),
                alpha = 0.2,
                fill = "#FEC98DFF"
                            )
    }
  if(input$line_proj %in% "all"){
  p_graph <- p_graph +
    geom_line(data = goal_tbl, aes(x=ds, y= qmod,
                                   color = "Projection (2017)"),
              stat = "identity"
                          ) +
    geom_line(data = plotdf, aes(x = ds, y = yhat,
                                 color = "Projection (historical)")) +
    geom_ribbon(data = plotdf, aes(x = ds, ymin = yhat_lower,
                                   ymax = yhat_upper),
              alpha = 0.2,
              fill = "#FEC98DFF"
                            )

  }
  if(input$proj_date != ymd("2017-04-07") &
     input$line_proj %in% "2017"){
     p_graph <- p_graph +
       geom_line(data = goal_tbl,
                 aes(x=ds, y= qmod_date,
                     color = "Projection (End Date)"),
                 stat = "identity",
                 linetype = 2) +
       guides(colour = guide_legend(override.aes = list(
                                    linetype=c(1,1,2,1))))
   }
    if(input$proj_date != ymd("2017-04-07") &
      input$line_proj %in% "prophet"){
     p_graph <- p_graph +
       geom_line(data = goal_tbl,
                 aes(x=ds, y= qmod_date,
                     color = "Projection (End Date)"),
                 stat = "identity",
                 linetype = 2) +
       guides(colour = guide_legend(override.aes = list(
                                    linetype=c(1,2,1,1))))
    }
   if(input$proj_date != ymd("2017-04-07") &
      input$line_proj %in% "all"){
     p_graph <- p_graph +
       geom_line(data = goal_tbl,
                 aes(x=ds, y= qmod_date,
                     color = "Projection (End Date)"),
                 stat = "identity",
                 linetype = 2) +
       guides(colour = guide_legend(override.aes = list(
                                    linetype=c(1,1,2,1,1))))
      }

  else {
   p_graph <- p_graph
  }

  p_graph
  })

```

Historical {data-navmenu="Contacts"}
========================================================

Inputs {.sidebar}
--------------------------------------------------------
```{r}
checkboxGroupInput("prophet_plot", "Show",
     choices = c("Successful" = "successful",
                 "Outreach" = "outreach",
                 "Both" = "both"),
     selected = "successful",
     inline = FALSE)

```

Row
---------------------------------------------------------
### Historical

```{r}
colors <- c("#440154FF",  "#FEC98DFF", "#238A8DFF")
names(colors) <- c("successful", "outreach", "both")
fillCol(flex= c(0.22, 0.22, 0.22, 0.32),
width = "100%", height = "100%",
        plotOutput("trend"),
        plotOutput("holiday"),
        plotOutput("weekly"),
        plotOutput("yearly")
)
output$trend <- renderPlot({

trend <-
  prophet_all %>%
  filter(type %in% input$prophet_plot) %>%
  ggplot( aes(x = ds, y = trend, color = type )) +
  geom_line() +
  geom_ribbon(ggplot2::aes(ymin = trend_lower,
                           ymax = trend_upper,
                           fill = type),
              alpha = 0.2,
              na.rm = TRUE,
              color = NA) +
   scale_fill_manual(values = colors
                                ) +
   scale_color_manual(values = colors
                                 ) +
  theme_bw() +
  theme(legend.position = "none") +
  xlab("")

trend
})


output$holiday <- renderPlot({
  df_s <- data.frame(ds = prophetdf_success$ds,
                     holidays = rowSums(prophetdf_success[,
                                                          holiday_comps,
                                                          drop = FALSE]),
                     holidays_lower = rowSums(prophetdf_success[,
                                                                paste0(
                                                                  holiday_comps,
                                                                  "_lower"),
                                                          drop = FALSE]),
                     holidays_upper = rowSums(prophetdf_success[,
                                                                paste0(
                                                                  holiday_comps,
                                                                  "_upper"),
                                                          drop = FALSE]),
                     type = "successful")

  df_o <- data.frame(ds = prophetdf_outreach$ds,
                     holidays = rowSums(prophetdf_outreach[,
                                                           holiday_comps,
                                                           drop =FALSE]),
                     holidays_lower = rowSums(prophetdf_outreach[,
                                                                 paste0(
                                                                   holiday_comps,
                                                                   "_lower"),
                                                              drop = FALSE]),
                     holidays_upper = rowSums(prophetdf_outreach[,
                                                                 paste0(
                                                                   holiday_comps,
                                                                   "_upper"),
                                                              drop = FALSE]),
                     type = "outreach")

  df_b <- data.frame(ds = prophetdf_both$ds,
                     holidays = rowSums(prophetdf_both[,
                                                       holiday_comps,
                                                       drop = FALSE]),
                     holidays_lower = rowSums(prophetdf_both[,
                                                             paste0(
                                                               holiday_comps,
                                                               "_lower"),
                                                           drop = FALSE]),
                     holidays_upper = rowSums(prophetdf_both[,
                                                             paste0(
                                                               holiday_comps,
                                                               "_upper"),
                                                               drop = FALSE]),
                     type = "both")
  df_all <- bind_rows(df_s, df_o, df_b)

  holiday <-  df_all %>%
    filter(type %in% input$prophet_plot,
      ds < today() + weeks(1)) %>%
    ggplot(aes(x = ds, y = holidays, color = type)) +
    geom_line() +
    geom_ribbon(aes(ymin = holidays_lower,
                      ymax = holidays_upper,
                    fill = type),
                  alpha = 0.2,
                  color = NA,
                  na.rm = TRUE) +
    scale_fill_manual(values = colors
                                ) +
    scale_color_manual(values = colors
                                 ) +
      theme_bw() +
      theme(legend.position = "none") +
      xlab("")


  holiday
})


output$weekly <- renderPlot({
  days <- weekdays(seq.Date(as.Date('2017-01-01'), by='d', length.out=7))
  df_s <- prophetdf_success %>%
    dplyr::mutate(dow = factor(weekdays(ds), levels = days)) %>%
    dplyr::group_by(dow) %>%
    dplyr::slice(1) %>%
    dplyr::ungroup() %>%
    dplyr::arrange(dow) %>%
    dplyr::mutate(type = "successful")

  df_o <-  prophetdf_outreach %>%
    dplyr::mutate(dow = factor(weekdays(ds), levels = days)) %>%
    dplyr::group_by(dow) %>%
    dplyr::slice(1) %>%
    dplyr::ungroup() %>%
    dplyr::arrange(dow) %>%
    dplyr::mutate(type = "outreach")

  df_b <-  prophetdf_both %>%
    dplyr::mutate(dow = factor(weekdays(ds), levels = days)) %>%
    dplyr::group_by(dow) %>%
    dplyr::slice(1) %>%
    dplyr::ungroup() %>%
    dplyr::arrange(dow) %>%
    dplyr::mutate(type = "both")

  df_all <- bind_rows(df_s, df_o, df_b)

  weekly <- df_all %>%
    filter(type %in% input$prophet_plot) %>%
    ggplot( aes(x = dow, y = weekly, group = type,
                     color = type)) +
    geom_line() +
    geom_ribbon(aes(ymin = weekly_lower,
                    ymax = weekly_upper,
                    fill = type),
                alpha = 0.2,
                color = NA,
                na.rm = TRUE) +
    scale_fill_manual(values = colors) +
    scale_color_manual(values = colors) +
    labs(x = "Day of week") +
    theme_bw() +
    theme(legend.position = "none")

  weekly
})


output$yearly <- renderPlot({
  df_s <- prophetdf_success %>%
    dplyr::mutate(doy = strftime(ds, format = "2000-%m-%d")) %>%
    dplyr::group_by(doy) %>%
    dplyr::slice(1) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(doy = zoo::as.Date(doy)) %>%
    dplyr::arrange(doy) %>%
    dplyr::mutate(type = "successful")


  df_o <- prophetdf_outreach %>%
    dplyr::mutate(doy = strftime(ds, format = "2000-%m-%d")) %>%
    dplyr::group_by(doy) %>%
    dplyr::slice(1) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(doy = zoo::as.Date(doy)) %>%
    dplyr::arrange(doy) %>%
    dplyr::mutate(type = "outreach")

  df_b <- prophetdf_both %>%
    dplyr::mutate(doy = strftime(ds, format = "2000-%m-%d")) %>%
    dplyr::group_by(doy) %>%
    dplyr::slice(1) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(doy = zoo::as.Date(doy)) %>%
    dplyr::arrange(doy) %>%
    dplyr::mutate(type = "both")

  df_all <- bind_rows(df_s, df_o, df_b)

  names(colors) <- stringi::stri_trans_totitle(attr(colors, "names"))
  yearly <- df_all %>%
    filter(type %in% input$prophet_plot) %>%
    mutate(type = stringi::stri_trans_totitle(type)) %>%
  ggplot(ggplot2::aes(x = doy, y = yearly,
                      group = type,
                      color = type)) +
  geom_line() +
  geom_ribbon(aes(ymin = yearly_lower,
                  ymax = yearly_upper,
                  fill = type),
              alpha = 0.2,
              color = NA)  +
  scale_x_date(labels = scales::date_format('%B %d')) +
  scale_fill_manual("", values = colors) +
  scale_color_manual("", values = colors) +
  labs(x = "Day of year") +
  theme_bw() +
  theme(legend.position = "bottom")


  yearly
})


```

HS Application Submission {data-orientation=columns}
============================================================

Overall Submissions Column
------------------------------------------------------------
### Students with one or more submitted applications
```{r}
plotOutput("hs_apps",
            click = clickOpts(id = "plot_click", clip = TRUE))

hs_2021 <- hs_applications %>%
  filter(grepl("KIPP", school),
         class %in% 2021,
         counselor %in% counselors_2021)

output$hs_apps <- renderPlot({

hs_2021 %>%
  unique() %>%
  mutate(value = TRUE) %>%
  spread(key = status, value = value, fill = FALSE) %>%
  clean_names %>%
  mutate(status = ifelse(submitted, "submitted",
                         ifelse(in_progress | wishlist, "prog_wish", "ns"))) %>%
  group_by(school, status) %>%
  summarise(N=n()) %>%
  ggplot(aes(x=fct_rev(status), y = N)) +
  geom_bar(aes(fill= status),
           show.legend = TRUE,
           stat="identity",
           width = .5) +
  facet_wrap("school", nrow = 1) +
  scale_fill_manual("", values = c("submitted" = "#440154FF",
                                   "prog_wish" = "#20A387FF",
                                   "ns" = "#FDE725FF"),
                     breaks = c("prog_wish", "ns", "submitted"),
                     labels = c("In Progress/Wishlist", "No Submission", "Submitted")
                     )+
  scale_x_discrete(breaks = NULL) +
  labs(x=NULL, y="Number of Students", fill = NULL) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold", hjust=0.5),
        axis.title.y = element_text(face="bold"),
        legend.position = "bottom")

})



```

###Student

```{r}
name_header <- reactive({
  # req(input$student_click)

names_ordered <- students_data_bar %>%
    ungroup %>%
    filter(school %in% input$plot_click[[3]]) %>%
    spread(key=status, value = n_applications) %>%
    arrange(submitted, no_status, wishlist) %>%
    select(name, class) %>%
    unique
#identify students from click position (from stacked bar plot)
plot_student_id <- ifelse(input$student_click[[2]] < 1, 1, floor(input$student_click[[2]]))

name_class <- list()

name_class$names_ordered <- names_ordered

name_class$student_id <- plot_student_id

name_class$names <- names_ordered[[1]][plot_student_id]

name_class$class <- names_ordered[[2]][plot_student_id]

name_class
})


```

```{r}
fillCol(flex = c(.15,.85),
p(strong(h4(textOutput("text")))),
tableOutput("students_table")
)



output$text <- renderText({
  req(input$student_click)

paste0(name_header()$names, ", Class of ", name_header()$class)

})

 output$students_table <- renderTable({
   #req(input$student_click)
   validate(
     need(input$student_click != "", "Click on the student bar plot to see a student's high school application history.")
   )
plot_student_id <- name_header()$student_id

plot_student_name <- name_header()$names_ordered[[1]][plot_student_id]

student_table %>%
   filter(grepl("KIPP", current_school),
          class %in% 2021,
          counselor %in% counselors_2021) %>%
   mutate(current_school = ifelse(grepl("Ascend", current_school),
                                  "KIPP Ascend Middle School", current_school)) %>%
     filter(current_school %in% input$plot_click[[3]]) %>%#add input$plot_click[[3]]
     mutate(name = sprintf("%s %s", first_name, last_name)) %>%
     #mutate(app_school_name = str_extract(app_school, ".*(?=-)")) %>% as.data.frame()
     #select(name, hs_name, sub_status, decision, matriculation) %>%
     mutate(sub_status = ifelse(is.na(sub_status) & is.na(hs_name) , "No Submission",
                                ifelse(is.na(sub_status),
                                       "No Status", sub_status))) %>%
  filter(name %in% plot_student_name) %>%
  select("High School Name" = hs_name, "Submission Status" = sub_status, Decision = decision,
         Matriculation = matriculation)

})

```

Schools
------------------------------------------------------------

### School View
```{r}
fillCol(flex = c(.07,.93),

p(strong(h4(textOutput("text2")))),

plotOutput("students_barplot",
            click = clickOpts(id = "student_click")
          )
)
output$text2 <- renderText({
req(input$plot_click)
 input$plot_click[[3]]
})

output$students_barplot <- renderPlot({
  validate(
    need(input$plot_click != "", "Click on a school plot to see high school application submission status by student."))
    hs_app(students_data_bar, input$plot_click[[3]])
})

```

Match {data-navmenu="College" data-orientation=columns}
========================================================

Column{data-width=500}
----------------------------------------------------------
### Match 2016

```{r}
plotOutput("match_overview", click = clickOpts(id = "match_click" ))

output$match_overview <- renderPlot({
  match_plot(match_data = final_undermatch,
           accepted_data = final_accept)
})

```

Column {data-width=500}
----------------------------------------------------------
### Student Match

```{r}
output$student_match_plot <- renderPlot({
  #req(input$match_click)
  validate(
    need(input$match_click != "", "Click on a student graph for more details.")
  )

  student_match <- final_undermatch %>%
   filter(student_name %in% input$match_click[[3]])

  student_accept <- final_accept %>%
  filter(student_name %in% input$match_click[[3]])

  if(student_match$undermatch == "undermatched"){
  lt <- "undermatched"
  col_fill <- "#255694"
} else {
  lt <- "matched"
  col_fill <- "#CFCCC1"
}
plot_student_m <- ggplot() +
  geom_rect(data = student_match,
            aes(linetype = lt),
            fill = col_fill,
            xmin = -Inf,
            xmax = Inf,
            ymin = -Inf,
            ymax = Inf) +
  geom_dotplot(data = student_accept %>%
               filter(school_matches %in% "no_match",
                      school_id != school_enroll),
               aes(x = plot,
                   y = ecc,
                   fill = school_matches),
               binwidth = 5,
               binaxis = "y",
               stackdir = "center",
               dotsize = 1
               ) +
  geom_dotplot(data = student_accept %>%
                 filter(school_matches %in% "match_school",
                        school_id != school_enroll),
               aes(x = plot,
                   y = ecc,
                   fill = school_matches),
               binwidth = 5,
               binaxis = "y",
               stackdir = "center",
               dotsize = 1
               ) +
  geom_dotplot(data = student_match,
               aes(x = plot,
                   y = enroll_ecc,
                   fill = "enrolled"),
               binwidth = 5,
               binaxis = "y",
               stackdir = "center",
               dotsize = 1
               ) +
  geom_hline(data = student_match,
             aes(yintercept = 40),
             color = "white",
             alpha = 0.25) +
  geom_hline(data = student_match,
             aes(yintercept = 60),
             color = "white",
             alpha = 0.25) +
  geom_hline(data = student_match,
             aes(yintercept = 80),
             color = "white",
             alpha = 0.25) +
 facet_wrap("student_name") +
 scale_color_manual("",
                    values = c("umatch_bound" = "#C49A6C"),
                    breaks = "umatch_bound",
                    labels = "Undermatch Boundary") +
 scale_fill_manual("",
                   values = c("enrolled" = "#E27425",
                              "no_match" = "white",
                              "match_school" = "#FEDA00"),
                   breaks = c("enrolled",
                              "match_school",
                              "no_match"),
                   labels = c("Enrollment",
                              "Matching Colleges",
                              "Non-matching Colleges")) +
 scale_x_discrete(breaks = c("school"),
                  labels = NULL) +
  scale_linetype_manual("",
                        values = c("undermatched" = 0,
                                   "matched" = 0),
                        breaks = c("undermatched",
                                   "matched"),
                        labels = c("Undermatch",
                                   "Match"),
                        guide = guide_legend(override.aes =
                                            list(fill =
                                              ifelse(lt == "undermatched",
                                                      "#255694", "#CFCCC1")
                                                      ))) +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          axis.ticks.x = element_blank(),
          legend.position = "none") +
          labs(x = "College Acceptances",
               y = "Expected College Completion (%)")


if(lt == "undermatched"){
 plot_match <- plot_student_m +
    geom_hline(data = student_match %>%
                filter(undermatch %in% "undermatched"),
               aes(yintercept = umatch_bound,
                   color = "umatch_bound"),
               linetype = 2)

  } else{
  plot_match <- plot_student_m
  }
  plot_match
})

```


```{r}

output$match_table <- renderFormattable({

  req(input$match_click)

  student_t <- final_accept %>%
    filter(school_id != school_enroll) %>%
    bind_rows(final_undermatch) %>%
    filter(student_name %in% input$match_click[[3]])

  student_table <- student_t %>%
    mutate(ecc = ifelse(is.na(ecc) & is.na(name.x), enroll_ecc, ecc),
           school_matches = ifelse(is.na(school_matches) &
                                   is.na(name.x),
                                   "enroll", school_matches),
           name.x = ifelse(is.na(name.x), name, name.x)) %>%
  group_by(id) %>%
  mutate(max_ecc = ifelse(is.na(max_ecc), max(ecc, na.rm = TRUE),
                          max_ecc),
         type2 = stringr::str_extract(type, "\\d\\s.+")
                          ) %>%
  ungroup() %>%
  mutate(ecc_diff = (max_ecc - ecc)) %>%
  select(College = name.x,
         ECC = ecc,
         ecc_diff,
         #"Undermatch Amount" = ecc_diff,
         Type = type2,
         school_id,
         school_enroll,
         school_matches,
         undermatch
           ) %>%
  mutate(ECC = formattable::percent(ECC/100, digits=1)
         #ecc_diff = ifelse(is.na(ecc_diff), "", ecc_diff)
         #ecc_diff = formattable::percent(ecc_diff, digits = 1)#,
         #
         ) %>%
  rename('Undermatch Amount' = ecc_diff) %>%
  arrange(desc(ECC)) %>%
  as.data.frame()

    formattable(student_table, align = c("l", "r", "r", "l"),
                list(formatter("span", style = x ~
                                style("border-style" = c("solid","5px"))),
                     College = formatter("span", style = ~
                                        style(display = "inline-block",
                                              "border-radius" = "4px",
                                              "padding-right" = "2px",
                                              "padding-left" = "2px",
                                              #font.weight = "bold",
                                              "background-color" =
                                              ifelse(is.na(ECC), "white",
                                              ifelse(undermatch ==
                                                "undermatched",
                                                "#255694", "#CFCCC1")),
                     color = ifelse(school_matches == "enroll", "#E27425",
                                   ifelse(school_matches == "match_school",
                                          "#FEDA00",
                                          "white")))),
                     'Undermatch Amount' = formatter("span", style = x ~
                                                    style(
                                                    display = "inline-block",
                                                    direction = "rtl",
                                                    "border-radius" = "4px",
                                                    "padding-right" = "2px",
                                                    width = percent(x/max(abs(x),
                                                                na.rm = TRUE)),
                                                    "background-color" =  ifelse(is.na(x), "white",
                                                    "#C49A6C")
                                                    )),
                  #  normalize_bar("burlywood",
                  #                na.rm = TRUE),
                     school_matches = FALSE,
                     school_enroll = FALSE,
                     undermatch = FALSE,
                     school_id = FALSE))
})

fillRow(flex = c(.45, .55),
        plotOutput("student_match_plot",
            click = clickOpts("student_match_click"),
            height = "50%"),
        formattableOutput("match_table", height = "20%")
        )
```



Classes {data-orientation=columns}
======================================================================
Inputs {.sidebar}
-----------------------------------------------------------------------
```{r}

selectInput("class2",
            "Class of",
            choices = classes,
            selected = 2013)

checkboxInput("noble",
            "Break out Noble",
            value = FALSE)



bookmarkButton()

br()

hr()

```
The **sunburst sequence** shows the selected class's complete set of sequences from HS matriculation to date, starting from the inside out.

**Mousing** over the sunburst will highlight a sequence and show a time line for every student that has followed the same sequence in the table below sunburst box title **Timelines**.  The center of the circle will show the total number and percent of students that have followed the same highlighted path.

Longer "wedges" that stick out far from the sunburst indicate sets of students that have had more transitions than those "wedges" that remain close to the center.

Row {data-height=300}
-----------------------------------------------------------------------
### Sunburst (all sequences of 8th grade completers)

```{r}

class_filtered <- reactive({
  class_all %>%
  filter(kipp_hs_class_c == input$class2)
  })

school_types<-dplyr::frame_data(
    ~type, ~type_short,
    "KIPP School",                  "KIPP",
    "Former KIPP School",           "KIPP",

    "Noble",                        "Noble",
    "Magnet Public School",         "Magnet",
    "Traditional Public School",    "TPS",
    "Charter Public School",        "Charter",
    "Alternative High School",      "Alt",
    "National/Boarding School",     "Boarding",
    "Independent Day School",       "Day",
    "Therapeutic School",           "Therapeutic",
    "Early College High School",    "Early College HS",
    "Private/Parochial Day School", "Private",

    "Private less-than 2 yr",       "Private (< 2yr)",

    "Private 2 yr",                 "Private (2 yr)",
    "Public 2 yr",                  "Public (2 yr)",

    "Private 4 yr",                 "Public College",
    "Public 4 yr",                  "Private College",

    "Other",                        "Other"
    )


class_sequences <- reactive({

  x <- class_filtered() %>%
          filter(!grepl("KIPP", type))

  if(input$noble) {
    x <- x %>% mutate(type = type_noble)
    }

  x <- x %>%
      inner_join(school_types, by="type") %>%
  group_by(id) %>%
  arrange(id, start_date) %>%
  summarize(sequence = tolower(paste(type_short, collapse = "-"))) %>%
  mutate(sequence = paste0(sequence, "-end"))
  })



output$sunburst <- renderSunburst({
  class_sequences() %>%
    group_by(sequence) %>%
    summarize(V2=n()) %>%
    arrange(desc(V2)) %>%
    rename(V1=sequence) %>%
    as.data.frame() %>%
    sunburst(count = TRUE) %>%
    add_shiny() %>%
    htmlwidgets::onRender(
      htmlwidgets::JS(
        "
        function(el,x){
          var endpaths = d3.select(el)
          .selectAll('path')[0]
          .filter(function(d){
            return d3.select(d).datum().name === 'end'
            });
          d3.selectAll(endpaths).style('fill','none');
        }
        "
  )
)
  })

  sequence_ids <- reactive({
    sequences <- paste(input$sunburst_mouseover, collapse = "-")

    x <- class_sequences()

    x %>%
      filter(str_detect(sequence, fixed(sequences))) %>%
      select(id)


    })

sunburstOutput("sunburst")

```

### Transition from original HS

```{r}

output$hs_outcome <- renderPlot({

  class_all_HS_placement <- class_filtered() %>%
    ungroup() %>%
    filter(type != "KIPP School") %>%
    group_by(id, first_name, last_name, kipp_hs_class_c) %>%
    filter(start_date == min(start_date)) %>%
    arrange(last_name, first_name)

  p <- class_all_HS_placement %>%
    ggplot() +
      geom_bar(aes(x = status_c, fill=status_c)
               ) +
    #facet_wrap(~kipp_hs_class_c) +
    viridis::scale_fill_viridis(discrete = TRUE, guide = FALSE) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    labs(x = "", y = "# of Alumni")

  if(input$noble) p <- p + facet_grid(~noble_2)

  p

  })


plotOutput("hs_outcome")

```


Row
-----------------------------------------------------------------------

### Timelines {data-height=8000}

```{r}




output$timeline <- renderTimevis({

class_filtered() %>%
  inner_join(sequence_ids(), by = "id") %>%
  plot_timeline()

  })

timevisOutput("timeline")

```
